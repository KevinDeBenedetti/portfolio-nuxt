name: Build & Deploy to Dokploy

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        type: string
        default: 'production'
    secrets:
      GITHUB_TOKEN:
        required: true
      DOKPLOY_API_TOKEN:
        required: true
      DOKPLOY_COMPOSE_ID_PROD:
        required: true
      DOKPLOY_COMPOSE_ID_DEV:
        required: true

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.set-env.outputs.BRANCH_NAME }}
      image_tag: ${{ steps.set-env.outputs.IMAGE_TAG }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        id: set-env
        run: |
          BRANCH_NAME=${GITHUB_REF##*/}
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
          IMAGE_TAG="$SAFE_BRANCH_NAME-${GITHUB_RUN_NUMBER}"
          LATEST_TAG="$SAFE_BRANCH_NAME-latest"
          REPO_LOWER=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "REPO_LOWER=$REPO_LOWER" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build \
            -t ghcr.io/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }} \
            -t ghcr.io/${{ env.REPO_LOWER }}:${{ env.LATEST_TAG }} .

      - name: Push Docker images
        run: |
          docker push ghcr.io/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }}
          docker push ghcr.io/${{ env.REPO_LOWER }}:${{ env.LATEST_TAG }}

      - name: Logout from registry
        if: always()
        run: docker logout ghcr.io

  deploy:
    name: Deploy to Dokploy
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'

    steps:
      - name: Determine deployment environment
        id: env
        run: |
          BRANCH="${{ github.ref_name }}"
          if [[ "$BRANCH" == "main" ]]; then
            echo "COMPOSE_ID=${{ secrets.DOKPLOY_COMPOSE_ID_PROD }}" >> $GITHUB_ENV
            echo "ENV_NAME=production" >> $GITHUB_ENV
          elif [[ "$BRANCH" == "dev" ]]; then
            echo "COMPOSE_ID=${{ secrets.DOKPLOY_COMPOSE_ID_DEV }}" >> $GITHUB_ENV
            echo "ENV_NAME=development" >> $GITHUB_ENV
          else
            echo "ERROR: Unsupported branch for deployment: $BRANCH"
            exit 1
          fi

      - name: Trigger Dokploy deployment
        run: |
          set -euo pipefail

          echo "Deploying to ${{ env.ENV_NAME }} environment..."

          PAYLOAD='{"composeId":"'"${COMPOSE_ID}"'"}'
          RESPONSE_FILE=$(mktemp)

          HTTP_CODE=$(curl -sS -o "$RESPONSE_FILE" -w "%{http_code}" \
            -X POST 'https://REDACTED_URL/api/compose.deploy' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H 'x-api-key: ${{ secrets.DOKPLOY_API_TOKEN }}' \
            -d "$PAYLOAD")

          echo "HTTP status: $HTTP_CODE"
          echo "Response:"
          cat "$RESPONSE_FILE" || true

          if [[ "$HTTP_CODE" -lt 200 || "$HTTP_CODE" -ge 300 ]]; then
            echo "❌ Deploy failed with HTTP $HTTP_CODE"
            exit 1
          fi

          if grep -qi "unauthorized\|error" "$RESPONSE_FILE"; then
            echo "❌ API error detected in response"
            exit 1
          fi

          echo "✅ Deployment triggered successfully for ${{ env.ENV_NAME }}"
