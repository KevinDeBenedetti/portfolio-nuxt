name: Build & Deploy

on:
  push:
    branches:
      - main
      - dev

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set environment variables
      id: set-env
      run: |
        BRANCH_NAME=${GITHUB_REF##*/}
        # Remplacer les caractÃ¨res invalides dans les tags Docker
        SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
        IMAGE_TAG="$SAFE_BRANCH_NAME-${GITHUB_RUN_NUMBER}"
        LATEST_TAG="$SAFE_BRANCH_NAME-latest"
        REPO_LOWER=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
        echo "REPO_LOWER=$REPO_LOWER" >> $GITHUB_ENV
        # Expose as step outputs pour usage au niveau du job
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT

    - uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}


    - name: Build Docker image
      run: |
        docker build \
          -t ghcr.io/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }} .

    - name: Push Docker image (versioned tag)
      run: |
        docker push ghcr.io/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }}

    - name: Tag image as branch-latest and push
      run: |
        docker tag ghcr.io/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }} \
          ghcr.io/${{ env.REPO_LOWER }}:${{ env.LATEST_TAG }}
        docker push ghcr.io/${{ env.REPO_LOWER }}:${{ env.LATEST_TAG }}

    - name: Logout
      run: docker logout ghcr.io

    outputs:
      branch: ${{ steps.set-env.outputs.BRANCH_NAME }}
      image_tag: ${{ steps.set-env.outputs.IMAGE_TAG }}

  deploy:
    name: Deploy on Dokploy
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'

    steps:
      - name: Determine Compose ID
        run: |
          BR=${{ github.ref_name }}
          COMPOSE_ID=${{ secrets.DOKPLOY_COMPOSE_ID_PROD }}
          if [[ "$BR" == "dev" ]]; then
            COMPOSE_ID=${{ secrets.DOKPLOY_COMPOSE_ID_DEV }}
          fi
          echo "COMPOSE_ID=$COMPOSE_ID" >> $GITHUB_ENV

      - name: Trigger Dokploy Deploy
        run: |
          set -euo pipefail
          PAYLOAD='{"composeId":"'"${COMPOSE_ID}"'"}'
          RESPONSE_FILE=$(mktemp)
          HTTP_CODE=$(curl -sS -o "$RESPONSE_FILE" -w "%{http_code}" -X POST 'https://dokploy.kevindb.dev/api/compose.deploy' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H 'x-api-key: ${{ secrets.DOKPLOY_API_TOKEN }}' \
            -d "$PAYLOAD")
          echo "HTTP status: $HTTP_CODE"
          echo "Response body:"
          cat "$RESPONSE_FILE" || true
          if [[ "$HTTP_CODE" -lt 200 || "$HTTP_CODE" -ge 300 ]]; then
            echo "ERROR: Deploy trigger failed with HTTP $HTTP_CODE"
            exit 1
          fi
          if grep -qi unauthorized "$RESPONSE_FILE"; then
            echo "ERROR: Unauthorized response from Dokploy API"
            exit 1
          fi
          echo "Deploy triggered successfully"
