name: Build and Deploy

on:
  push:
    branches:
      - main
      - dev

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set environment variables
      run: |
        BRANCH_NAME=${GITHUB_REF##*/}
        # Remplacer les caractÃ¨res invalides dans les tags Docker
        SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
        IMAGE_TAG="$SAFE_BRANCH_NAME-${GITHUB_RUN_NUMBER}"
        LATEST_TAG="$SAFE_BRANCH_NAME-latest"
        REPO_LOWER=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
        echo "REPO_LOWER=$REPO_LOWER" >> $GITHUB_ENV

    - uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}


    - name: Build Docker image
      run: |
        docker build \
          --build-arg NUXT_GTAG_ID="${{ secrets.NUXT_GTAG_ID }}" \
          --build-arg NODE_ENV="${{ secrets.NODE_ENV }}" \
          -t ghcr.io/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }} .
  
    - name: Push Docker image (versioned tag)
      run: |
        docker push ghcr.io/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }}

    - name: Tag image as branch-latest and push
      run: |
        docker tag ghcr.io/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }} \
          ghcr.io/${{ env.REPO_LOWER }}:${{ env.LATEST_TAG }}
        docker push ghcr.io/${{ env.REPO_LOWER }}:${{ env.LATEST_TAG }}

    - name: Logout
      run: docker logout ghcr.io

    outputs:
      branch: ${{ steps.set-env.outputs.BRANCH_NAME }}
      image_tag: ${{ env.IMAGE_TAG }}

  deploy:
    name: Deploy on Dokploy
    needs: build                                             # 1) attendre le build :contentReference[oaicite:2]{index=2}
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'                     # 2) ne run que si build OK :contentReference[oaicite:3]{index=3}

    steps:
      - name: Determine Compose ID
        run: |
          BR=${{ github.ref_name }}                          # push event always has github.ref_name :contentReference[oaicite:4]{index=4}
          COMPOSE_ID=${{ secrets.DOKPLOY_COMPOSE_ID_PROD }}
          if [[ "$BR" == "dev" ]]; then
            COMPOSE_ID=${{ secrets.DOKPLOY_COMPOSE_ID_DEV }}
          fi
          echo "COMPOSE_ID=$COMPOSE_ID" >> $GITHUB_ENV

      - name: Trigger Dokploy Deploy
        run: |
          curl -X POST 'https://REDACTED_URL/api/compose.deploy' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H 'x-api-key: ${{ secrets.DOKPLOY_API_TOKEN }}' \
            -d '{"composeId":"'"${COMPOSE_ID}"'"}'