name: PR â€“ Lint, Build & Test

on:
  workflow_dispatch:
  # pull_request:
  #   branches:
  #     - main
  #     - dev
  #   types: [opened, synchronize, reopened]

permissions:
  contents: read
  packages: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Lint client
        run: |
          pnpm lint

  build:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          BRANCH_NAME=${GITHUB_HEAD_REF}  # Utilise la branche de la PR
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
          IMAGE_TAG="pr-${{ github.event.number }}-${GITHUB_RUN_NUMBER}"
          REPO_LOWER=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "REPO_LOWER=$REPO_LOWER" >> $GITHUB_ENV

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image (test only)
        run: |
          docker build \
            --build-arg NUXT_GTAG_ID="${{ secrets.NUXT_GTAG_ID }}" \
            --build-arg NODE_ENV="${{ secrets.NODE_ENV }}" \
            -t ghcr.io/${{ env.REPO_LOWER }}:${{ env.IMAGE_TAG }} .
